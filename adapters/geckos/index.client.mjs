var I="insert",z="update",J="delete",G="reverse",W="shuffle",m=Symbol.for("object-observer-meta-key-0"),et={async:1},nt=n=>{if(!n||typeof n!="object")return null;let t={},e=[];for(let[o,r]of Object.entries(n))if(o==="path"){if(typeof r!="string"||r==="")throw new Error('"path" option, if/when provided, MUST be a non-empty string');t[o]=r}else if(o==="pathsOf"){if(n.path)throw new Error('"pathsOf" option MAY NOT be specified together with "path" option');if(typeof r!="string")throw new Error('"pathsOf" option, if/when provided, MUST be a string (MAY be empty)');t[o]=n.pathsOf.split(".").filter(Boolean)}else if(o==="pathsFrom"){if(n.path||n.pathsOf)throw new Error('"pathsFrom" option MAY NOT be specified together with "path"/"pathsOf" option/s');if(typeof r!="string"||r==="")throw new Error('"pathsFrom" option, if/when provided, MUST be a non-empty string');t[o]=r}else e.push(o);if(e.length)throw new Error(`'${e.join(", ")}' is/are not a valid observer option/s`);return t},ot=(n,t,e)=>{let o={};o[m]=t;for(let r in n)o[r]=$(n[r],r,t,e);return o},rt=(n,t,e)=>{let o=n.length,r=new Array(o);r[m]=t;for(let s=0;s<o;s++)r[s]=$(n[s],s,t,e);return r},st=(n,t)=>(n[m]=t,n),it=(n,t)=>{if(n===null)return t;let e=t;if(n.path){let o=n.path;e=t.filter(r=>r.path.join(".")===o)}else if(n.pathsOf){let o=n.pathsOf,r=o.join(".");e=t.filter(s=>(s.path.length===o.length+1||s.path.length===o.length&&(s.type===G||s.type===W))&&s.path.join(".").startsWith(r))}else if(n.pathsFrom){let o=n.pathsFrom;e=t.filter(r=>r.path.join(".").startsWith(o))}return e},H=(n,t)=>{try{n(t)}catch(e){console.error(`failed to notify listener ${n} with ${t}`,e)}},at=function(){let n=this.batches;this.batches=[];for(let[t,e]of n)H(t,e)},D=(n,t)=>{let e=n,o,r,s,c,i,M,y=t.length;do{for(o=e.options.async,r=e.observers,M=r.length;M--;)if([s,c]=r[M],i=it(c,t),i.length)if(o){e.batches.length===0&&queueMicrotask(at.bind(e));let p;for(let E of e.batches)if(E[0]===s){p=E;break}p||(p=[s,[]],e.batches.push(p)),Array.prototype.push.apply(p[1],i)}else H(s,i);let b=e.parent;if(b){for(let p=0;p<y;p++){let E=t[p];t[p]=new P(E.type,[e.ownKey,...E.path],E.value,E.oldValue,E.object)}e=b}else e=null}while(e)},$=(n,t,e,o)=>o!==void 0&&o.has(n)?null:typeof n!="object"||n===null?n:Array.isArray(n)?new B({target:n,ownKey:t,parent:e,visited:o}).proxy:ArrayBuffer.isView(n)?new Y({target:n,ownKey:t,parent:e}).proxy:n instanceof Date?n:new K({target:n,ownKey:t,parent:e,visited:o}).proxy,ct=function(){let n=this[m],t=n.target,e=t.length-1,o=t.pop();if(o&&typeof o=="object"){let s=o[m];s&&(o=s.detach())}let r=[new P(J,[e],void 0,o,this)];return D(n,r),o},ht=function(){let n=this[m],t=n.target,e=arguments.length,o=new Array(e),r=t.length;for(let i=0;i<e;i++)o[i]=$(arguments[i],r+i,n);let s=Reflect.apply(t.push,t,o),c=[];for(let i=r,M=t.length;i<M;i++)c[i-r]=new P(I,[i],t[i],void 0,this);return D(n,c),s},lt=function(){let n=this[m],t=n.target,e,o,r,s,c;for(e=t.shift(),e&&typeof e=="object"&&(c=e[m],c&&(e=c.detach())),o=0,r=t.length;o<r;o++)s=t[o],s&&typeof s=="object"&&(c=s[m],c&&(c.ownKey=o));let i=[new P(J,[0],void 0,e,this)];return D(n,i),e},ut=function(){let n=this[m],t=n.target,e=arguments.length,o=new Array(e);for(let i=0;i<e;i++)o[i]=$(arguments[i],i,n);let r=Reflect.apply(t.unshift,t,o);for(let i=0,M=t.length,y;i<M;i++)if(y=t[i],y&&typeof y=="object"){let b=y[m];b&&(b.ownKey=i)}let s=o.length,c=new Array(s);for(let i=0;i<s;i++)c[i]=new P(I,[i],t[i],void 0,this);return D(n,c),r},q=function(){let n=this[m],t=n.target,e,o,r;for(t.reverse(),e=0,o=t.length;e<o;e++)if(r=t[e],r&&typeof r=="object"){let c=r[m];c&&(c.ownKey=e)}let s=[new P(G,[],void 0,void 0,this)];return D(n,s),this},Q=function(n){let t=this[m],e=t.target,o,r,s;for(e.sort(n),o=0,r=e.length;o<r;o++)if(s=e[o],s&&typeof s=="object"){let i=s[m];i&&(i.ownKey=o)}let c=[new P(W,[],void 0,void 0,this)];return D(t,c),this},X=function(n,t,e){let o=this[m],r=o.target,s=[],c=r.length,i=r.slice(0);if(t=t===void 0?0:t<0?Math.max(c+t,0):Math.min(t,c),e=e===void 0?c:e<0?Math.max(c+e,0):Math.min(e,c),t<c&&e>t){r.fill(n,t,e);let M;for(let y=t,b,p;y<e;y++)b=r[y],r[y]=$(b,y,o),y in i?(p=i[y],p&&typeof p=="object"&&(M=p[m],M&&(p=M.detach())),s.push(new P(z,[y],r[y],p,this))):s.push(new P(I,[y],r[y],void 0,this));D(o,s)}return this},Z=function(n,t,e){let o=this[m],r=o.target,s=r.length;n=n<0?Math.max(s+n,0):n,t=t===void 0?0:t<0?Math.max(s+t,0):Math.min(t,s),e=e===void 0?s:e<0?Math.max(s+e,0):Math.min(e,s);let c=Math.min(e-t,s-n);if(n<s&&n!==t&&c>0){let i=r.slice(0),M=[];r.copyWithin(n,t,e);for(let y=n,b,p,E;y<n+c;y++)b=r[y],b&&typeof b=="object"&&(b=$(b,y,o),r[y]=b),p=i[y],p&&typeof p=="object"&&(E=p[m],E&&(p=E.detach())),!(typeof b!="object"&&b===p)&&M.push(new P(z,[y],b,p,this));D(o,M)}return this},ft=function(){let n=this[m],t=n.target,e=arguments.length,o=new Array(e),r=t.length;for(let g=0;g<e;g++)o[g]=$(arguments[g],g,n);let s=e===0?0:o[0]<0?r+o[0]:o[0],c=e<2?r-s:o[1],i=Math.max(e-2,0),M=Reflect.apply(t.splice,t,o),y=t.length,b;for(let g=0,x;g<y;g++)x=t[g],x&&typeof x=="object"&&(b=x[m],b&&(b.ownKey=g));let p,E,d;for(p=0,E=M.length;p<E;p++)d=M[p],d&&typeof d=="object"&&(b=d[m],b&&(M[p]=b.detach()));let f=[],l;for(l=0;l<c;l++)l<i?f.push(new P(z,[s+l],t[s+l],M[l],this)):f.push(new P(J,[s+l],void 0,M[l],this));for(;l<i;l++)f.push(new P(I,[s+l],t[s+l],void 0,this));return D(n,f),M},pt=function(n,t){let e=this[m],o=e.target,r=n.length,s=o.slice(0);t=t||0,o.set(n,t);let c=new Array(r);for(let i=t;i<r+t;i++)c[i-t]=new P(z,[i],o[i],s[i],this);D(e,c)},dt={pop:ct,push:ht,shift:lt,unshift:ut,reverse:q,sort:Q,fill:X,copyWithin:Z,splice:ft},gt={reverse:q,sort:Q,fill:X,copyWithin:Z,set:pt},P=class{constructor(t,e,o,r,s){this.type=t,this.path=e,this.value=o,this.oldValue=r,this.object=s}},N=class{constructor(t,e){let{target:o,parent:r,ownKey:s,visited:c=new Set}=t;r&&s!==void 0?(this.parent=r,this.ownKey=s):(this.parent=null,this.ownKey=null),c.add(o);let i=e(o,this,c);c.delete(o),this.observers=[],this.revocable=Proxy.revocable(i,this),this.proxy=this.revocable.proxy,this.target=i,this.options=this.processOptions(t.options),this.options.async&&(this.batches=[])}processOptions(t){if(t){if(typeof t!="object")throw new Error(`Observable options if/when provided, MAY only be an object, got '${t}'`);let e=Object.keys(t).filter(o=>!(o in et));if(e.length)throw new Error(`'${e.join(", ")}' is/are not a valid Observable option/s`);return Object.assign({},t)}else return{}}detach(){return this.parent=null,this.target}set(t,e,o){let r=t[e];if(o!==r){let s=$(o,e,this);if(t[e]=s,r&&typeof r=="object"){let i=r[m];i&&(r=i.detach())}let c=r===void 0?[new P(I,[e],s,void 0,this.proxy)]:[new P(z,[e],s,r,this.proxy)];D(this,c)}return!0}deleteProperty(t,e){let o=t[e];if(delete t[e],o&&typeof o=="object"){let s=o[m];s&&(o=s.detach())}let r=[new P(J,[e],void 0,o,this.proxy)];return D(this,r),!0}},K=class extends N{constructor(t){super(t,ot)}},B=class extends N{constructor(t){super(t,rt)}get(t,e){return dt[e]||t[e]}},Y=class extends N{constructor(t){super(t,st)}get(t,e){return gt[e]||t[e]}},F=Object.freeze({from:(n,t)=>{if(!n||typeof n!="object")throw new Error("observable MAY ONLY be created from a non-null object");if(n[m])return n;if(Array.isArray(n))return new B({target:n,ownKey:null,parent:null,options:t}).proxy;if(ArrayBuffer.isView(n))return new Y({target:n,ownKey:null,parent:null,options:t}).proxy;if(n instanceof Date)throw new Error(`${n} found to be one of a non-observable types`);return new K({target:n,ownKey:null,parent:null,options:t}).proxy},isObservable:n=>!!(n&&n[m]),observe:(n,t,e)=>{if(!F.isObservable(n))throw new Error("invalid observable parameter");if(typeof t!="function")throw new Error(`observer MUST be a function, got '${t}'`);let o=n[m].observers;o.some(r=>r[0]===t)?console.warn("observer may be bound to an observable only once; will NOT rebind"):o.push([t,nt(e)])},unobserve:(n,...t)=>{if(!F.isObservable(n))throw new Error("invalid observable parameter");let e=n[m].observers,o=e.length;if(o){if(!t.length){e.splice(0);return}for(;o;)t.indexOf(e[--o][0])>=0&&e.splice(o,1)}}});var V=class{constructor(t){this.id=t}emit(t="",...e){return null}on(t="",e=null){return null}onDisconnect(){}};var vt;(()=>{"use strict";var n={118:function(r,s,c){var i=this&&this.__spreadArray||function(d,f){for(var l=0,g=f.length,x=d.length;l<g;l++,x++)d[x]=f[l];return d};Object.defineProperty(s,"__esModule",{value:!0}),s.Events=void 0;var M=c(939),y=function(d,f,l){l===void 0&&(l=!1),this.fn=d,this.context=f,this.once=l},b=function(d,f,l,g,x){if(typeof l!="function")throw new TypeError("The listener must be a function");var j=new y(l,g||d,x);return d._events.has(f)?d._events.get(f).fn?d._events.set(f,[d._events.get(f),j]):d._events.get(f).push(j):(d._events.set(f,j),d._eventsCount++),d},p=function(d,f){--d._eventsCount==0?d._events=new Map:d._events.delete(f)},E=function(){function d(){this._events=new Map,this._eventsCount=0}return Object.defineProperty(d,"VERSION",{get:function(){return M.VERSION},enumerable:!1,configurable:!0}),d.prototype.eventNames=function(){return Array.from(this._events.keys())},d.prototype.listeners=function(f){var l=this._events.get(f);if(!l)return[];if(l.fn)return[l.fn];for(var g=0,x=l.length,j=new Array(x);g<x;g++)j[g]=l[g].fn;return j},d.prototype.listenerCount=function(f){var l=this._events.get(f);return l?l.fn?1:l.length:0},d.prototype.emit=function(f){for(var l,g,x=[],j=1;j<arguments.length;j++)x[j-1]=arguments[j];if(!this._events.has(f))return!1;var A,S=this._events.get(f);if(S.fn)return S.once&&this.removeListener(f,S.fn,void 0,!0),(l=S.fn).call.apply(l,i([S.context],x)),!0;var w=S.length;for(A=0;A<w;A++)S[A].once&&this.removeListener(f,S[A].fn,void 0,!0),(g=S[A].fn).call.apply(g,i([S[A].context],x));return!0},d.prototype.on=function(f,l,g){return b(this,f,l,g,!1)},d.prototype.once=function(f,l,g){return b(this,f,l,g,!0)},d.prototype.removeListener=function(f,l,g,x){if(!this._events.has(f))return this;if(!l)return p(this,f),this;var j=this._events.get(f);if(j.fn)j.fn!==l||x&&!j.once||g&&j.context!==g||p(this,f);else{for(var A=0,S=[],w=j.length;A<w;A++)(j[A].fn!==l||x&&!j[A].once||g&&j[A].context!==g)&&S.push(j[A]);S.length?this._events.set(f,S.length===1?S[0]:S):p(this,f)}return this},d.prototype.removeAllListeners=function(f){return f?this._events.delete(f)&&p(this,f):(this._events=new Map,this._eventsCount=0),this},Object.defineProperty(d.prototype,"off",{get:function(){return this.removeListener},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"addListener",{get:function(){return this.on},enumerable:!1,configurable:!0}),d}();s.Events=E},939:(r,s)=>{Object.defineProperty(s,"__esModule",{value:!0}),s.VERSION=void 0,s.VERSION="0.0.5"}},t={};function e(r){var s=t[r];if(s!==void 0)return s.exports;var c=t[r]={exports:{}};return n[r].call(c.exports,c,c.exports,e),c.exports}e.d=(r,s)=>{for(var c in s)e.o(s,c)&&!e.o(r,c)&&Object.defineProperty(r,c,{enumerable:!0,get:s[c]})},e.o=(r,s)=>Object.prototype.hasOwnProperty.call(r,s);var o={};(()=>{e.d(o,{default:()=>S});var r=e(118);class s{constructor(){this.eventEmitter=new r.Events}emit(a,u,h={}){this.eventEmitter.emit(a,u,h)}on(a,u){return this.eventEmitter.on(a,(h,v)=>{u(h,v)})}removeAllListeners(){this.eventEmitter.removeAllListeners()}}new s;let c="disconnected",i="rawMessage",M="BROWSER_NOT_SUPPORTED",y="COULD_NOT_PARSE_MESSAGE",b=Object.getPrototypeOf(Object.getPrototypeOf(new Uint8Array)).constructor,p=(typeof Promise=="function"&&Promise.prototype.then.bind(Promise.resolve()),w=>typeof w=="string"),E=w=>w instanceof ArrayBuffer||w instanceof b,d=w=>{let{data:a}=w;a||(a=w);let u=E(a),h=(C=>{try{return typeof C=="string"&&!!isNaN(parseInt(C))&&(JSON.parse(C),!0)}catch{return!1}})(a),v=p(a);if(h){let C=JSON.parse(a),O=Object.keys(C)[0];return{key:O,data:C[O]}}return u||v?{key:i,data:a}:{key:"error",data:new Error(y)}},f=(w,a,u,h=null)=>{var v;let C=(O,_)=>{var T;let k=(T=O.byteLength)!==null&&T!==void 0?T:2*O.length;if(typeof a=="number"&&k>a)throw new Error(`maxMessageSize of ${a} exceeded`);Promise.resolve().then(()=>{w.send?w.send(O):_?w.sendMessageBinary(Buffer.from(O)):w.sendMessage(O)}).catch(L=>{console.log("error",L)})};if(w&&(w.readyState==="open"||!((v=w.isOpen)===null||v===void 0)&&v.call(w)))try{u===i&&h!==null&&(p(h)||E(h))?C(h,E(h)):C(JSON.stringify({[u]:h}),!1)}catch(O){return console.error("Error in sendMessage.ts: ",O.message),O}};class l{constructor(a,u,h,v){this.url=a,this.authorization=u,this.label=h,this.rtcConfiguration=v,this.bridge=new s,this.onDataChannel=C=>{let{channel:O}=C;O.label===this.label&&(this.dataChannel=O,this.dataChannel.binaryType="arraybuffer",this.dataChannel.onmessage=_=>{let{key:T,data:k}=d(_);this.bridge.emit(T,k)})}}emit(a,u=null){f(this.dataChannel,this.maxMessageSize,a,u)}async fetchAdditionalCandidates(a,u){var h;if(((h=this.dataChannel)===null||h===void 0?void 0:h.readyState)==="closed")return;let v=await fetch(`${a}/connections/${u}/additional-candidates`,{method:"GET",headers:{"Content-Type":"application/json"}});v.ok&&(await v.json()).forEach(C=>{this.localPeerConnection.addIceCandidate(C)})}async connect(){let a=`${this.url}/.wrtc/v2`,u={"Content-Type":"application/json"};this.authorization&&(u={...u,Authorization:this.authorization});let h={};try{let T=await fetch(`${a}/connections`,{method:"POST",headers:u});if(T.status>=300)throw{name:"Error",message:`Connection failed with status code ${T.status}.`,status:T.status,statusText:T.statusText};let k=await T.json();h=k.userData,this.remotePeerConnection=k}catch(T){return console.error(T.message),{error:T}}let{id:v,localDescription:C}=this.remotePeerConnection,O={sdpSemantics:"unified-plan",...this.rtcConfiguration},_=RTCPeerConnection||webkitRTCPeerConnection;this.localPeerConnection=new _(O),((T=10,k=50,L=1.8,R=20)=>Array(T).fill(0).map((bt,tt)=>parseInt((k*L**tt).toString())+parseInt((Math.random()*R).toString())))().forEach(T=>{setTimeout(()=>{this.fetchAdditionalCandidates(a,v).catch(()=>{})},T)});try{await this.localPeerConnection.setRemoteDescription(C),this.localPeerConnection.addEventListener("datachannel",this.onDataChannel,{once:!0});let T=await this.localPeerConnection.createAnswer(),k=new RTCSessionDescription({type:"answer",sdp:T.sdp});await this.localPeerConnection.setLocalDescription(k);try{await fetch(`${a}/connections/${v}/remote-description`,{method:"POST",body:JSON.stringify(this.localPeerConnection.localDescription),headers:{"Content-Type":"application/json"}})}catch(R){return console.error(R.message),{error:R}}let L=()=>new Promise(R=>{this.localPeerConnection.addEventListener("datachannel",()=>{R()},{once:!0})});return this.dataChannel||await L(),{userData:h,localPeerConnection:this.localPeerConnection,dataChannel:this.dataChannel,id:v}}catch(T){return console.error(T.message),this.localPeerConnection.close(),{error:T}}}}class g{async connect(a){if(RTCPeerConnection||webkitRTCPeerConnection){let{localPeerConnection:u,dataChannel:h,id:v,userData:C,error:O}=await a.connect();return O?{error:O}:u&&h&&v&&C?(this.localPeerConnection=u,this.dataChannel=h,this.id=v,{userData:C}):{error:new Error('Something went wrong in "await connectionsManager.connect()"')}}{let u=new Error(M);return console.error(u.message),{error:u}}}}let x=(w=24)=>{let a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",u="";for(let h=0;h<w;h++)u+=a.charAt(Math.floor(Math.random()*a.length));return u},j=(w=200,a=1,u)=>{let h=0;if(typeof u!="function")return void console.error("You have to define your callback function!");let v=setInterval(()=>{u(),h++,h===a-1&&clearInterval(v)},w);u()};class A{constructor(a,u,h,v,C){this.userData={},this.receivedReliableMessages=[],this.url=h?`${a}:${h}`:a,this.connectionsManager=new l(this.url,u,v,C),this.bridge=this.connectionsManager.bridge,this.bridge.on(c,()=>this.bridge.removeAllListeners())}onconnectionstatechange(){let a=this.peerConnection.localPeerConnection;a.onconnectionstatechange=()=>{a.connectionState!=="disconnected"&&a.connectionState!=="closed"||this.bridge.emit(c)}}get id(){return this.peerConnection.id}close(){this.peerConnection.localPeerConnection.close(),this.bridge.emit(c);try{let a=`${this.url}/.wrtc/v2`;fetch(`${a}/connections/${this.id}/close`,{method:"POST",headers:{"Content-Type":"application/json"}})}catch(a){console.error(a.message)}}emit(a,u=null,h){h&&h.reliable?((v,C)=>{let{interval:O=150,runs:_=10}=v,T=x(24);j(O,_,()=>{C(T)})})(h,v=>this.connectionsManager.emit(a,{MESSAGE:u,RELIABLE:1,ID:v})):this.connectionsManager.emit(a,u)}get raw(){return{emit:a=>this.emit(i,a)}}onRaw(a){this.bridge.on(i,u=>{(h=>{a(h)})(u)})}async onConnect(a){var u;this.peerConnection=new g;let h=await this.peerConnection.connect(this.connectionsManager);h.error?a(h.error):(h.userData&&(this.userData=h.userData),this.maxMessageSize=this.connectionsManager.maxMessageSize=(u=this.peerConnection.localPeerConnection.sctp)===null||u===void 0?void 0:u.maxMessageSize,this.onconnectionstatechange(),a())}onDisconnect(a){this.bridge.on(c,a)}on(a,u){this.bridge.on(a,h=>{h&&h.RELIABLE===1&&h.ID!=="undefined"?((()=>{let v=new Date().getTime();this.receivedReliableMessages.forEach((C,O,_)=>{C.expire<=v&&_.splice(O,1)})})(),this.receivedReliableMessages.filter(v=>v.id===h.ID).length===0&&(this.receivedReliableMessages.push({id:h.ID,timestamp:new Date,expire:new Date().getTime()+15e3}),u(h.MESSAGE))):u(h)})}}let S=(w={})=>{let{authorization:a,iceServers:u=[],iceTransportPolicy:h="all",label:v="geckos.io",port:C=9208,url:O=`${location.protocol}//${location.hostname}`}=w;return new A(O,a,C,v,{iceServers:u,iceTransportPolicy:h})}})(),vt=o.default})();var U=class extends V{#t;constructor(t){super(t.id),this.#t=t}emit(t,...e){this.#t.emit(t,...e)}on(t,e){this.#t.on(t,o=>{try{e(this,o)}catch(r){console.log(r)}})}onDisconnect(t){try{this.#t.onDisconnect(t)}catch(e){console.log(e)}}},yt=(n="http://127.0.0.1:3000/",t)=>{let e=geckos({url:n,authorization:"default"});e.onConnect(o=>{let r=new U(e);t(r,o)})};typeof window<"u"&&(window.CapyAdapter=yt);export{yt as adapter};
